name: Build production and nightly artifacts
on:
    push:
        branches:
            - main
        tags:
            - 'v*'
    workflow_dispatch:
    schedule:
        # Every week on Sunday at midnight
        - cron: '0 0 * * 0'

permissions:
    contents: write
    actions: write

env:
    GITHUB_SHA: ${{ github.sha }}

jobs:
    build:
        runs-on: ubuntu-latest
        outputs:
            TYPE_OF_BUILD: ${{ steps.final-type.outputs.TYPE_OF_BUILD }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            # Logic to determine build type
            - name: Setup build type
              id: set-type
              run: |
                  if [ "${{ github.event_name }}" = "schedule" ]; then
                    TYPE="nightly"
                  elif [ "${{ github.event.ref_type }}" = "tag" ]; then
                    TYPE="release"
                  elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
                    TYPE="production"
                  else
                    TYPE="development"
                  fi
                  echo "SELECTED_TYPE=$TYPE" >> $GITHUB_ENV
            - name: Finalize Build Type Output
              id: final-type
              run: echo "TYPE_OF_BUILD=$SELECTED_TYPE" >> $GITHUB_OUTPUT

            - name: Setup PHP with PECL extension
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.4'
                  extensions: mbstring, intl, gd, pdo_mysql, zip, exif, pcntl, bcmath, soap, imagick, xdebug, opcache
                  tools: composer:v2

            - name: Install Composer dependencies
              run: composer install --no-interaction --prefer-dist --optimize-autoloader

            - name: Install NPM modules
              uses: actions/setup-node@v4
              with:
                  node-version: 22

            - run: npm install --no-audit

            - name: Build frontend (Vite)
              run: npm run build

            - name: Remove unnecessary files and optimize
              run: |
                  composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist
                  npm prune --production
                  rm -rf .git .github .gitignore .gitattributes .editorconfig tailwind.config.js .env .eslintrc.cjs .prettierignore .prettierrc.json .jsconfig.json phpunit.xml version crowdin.yml install.lock postcss.config.js eslint.config.js sonar-project.properties

            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: biznisbox-payload
                  include-hidden-files: true
                  path: ${{ github.workspace }}/

    release:
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: Get current date
              id: date
              run: echo "date=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

            - name: Download artifacts
              uses: actions/download-artifact@v4
              with:
                  name: biznisbox-payload
                  path: ./payload

            - name: Create zip archive
              run: |
                  cd payload
                  zip -r ../biznisbox.zip .
                  cd ..
                  echo "Created biznisbox.zip"

            - name: Create release (Tags)
              if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
              uses: ncipollo/release-action@v1
              with:
                  allowUpdates: true
                  artifacts: 'biznisbox.zip'
                  name: ${{ github.ref_name }}
                  draft: true
                  tag: ${{ github.ref_name }}
                  body: |
                      # Changelog

                      ## ‚ú® New Features & Enhancements

                      - New features and enhancements in this release.

                      ## üêõ Bug Fixes

                      - Fixed bugs and issues in this release.

                      üöÄ Found a bug or issue? Report it here: [**Open Issues**](https://github.com/biznisbox/biznisbox/issues)

                      üê≥ [Docker Image](https://hub.docker.com/r/biznisbox/biznisbox/tags)

                      üìö [Documentation](https://docs.biznisbox.com)

                      ## Release Information
                        - **Version**: ${{ github.ref_name }}
                        - **Build Type**: ${{ needs.build.outputs.TYPE_OF_BUILD }}
                        - **Build Time**: ${{ steps.date.outputs.date }}
                  prerelease: false
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Create nightly release
              if: github.event_name == 'schedule'
              uses: ncipollo/release-action@v1
              with:
                  tag: nightly
                  allowUpdates: true
                  name: BiznisBox Nightly Build
                  artifacts: 'biznisbox.zip'
                  draft: false
                  makeLatest: false
                  body: |
                      This is a nightly build of BiznisBox.
                      Run ID: ${{ github.run_id }}
                      Build Type: ${{ needs.build.outputs.TYPE_OF_BUILD }}
                      Build Time: ${{ steps.date.outputs.date }}
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Create dev release
              if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/'))
              uses: ncipollo/release-action@v1
              with:
                  tag: dev
                  allowUpdates: true
                  name: BiznisBox Dev Build
                  artifacts: 'biznisbox.zip'
                  draft: false
                  makeLatest: false
                  body: |
                      This is a development build from the main branch.
                      Run ID: ${{ github.run_id }}
                      Build Type: ${{ needs.build.outputs.TYPE_OF_BUILD }}
                      Build Time: ${{ steps.date.outputs.date }}
                  token: ${{ secrets.GITHUB_TOKEN }}
